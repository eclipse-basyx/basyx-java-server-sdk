# Minimal Apache HTTP Server configuration for reverse proxy

Define PORT 80
Define HOSTNAME localhost

ServerRoot "/usr/local/apache2"
Listen ${PORT}
ServerName ${HOSTNAME}
ErrorLog /dev/stderr
CustomLog /dev/stdout combined
User daemon
Group daemon

# Load required modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so
LoadModule alias_module modules/mod_alias.so

# Virtual host for reverse proxy
<VirtualHost *:${PORT}>
    <Directory />
        Require all granted
    </Directory>

    # -----------------------------
    # Trailing-slash safety redirects
    # (Avoid falling through to "/" ProxyPass when user omits trailing slash)
    # -----------------------------
    RedirectMatch 301 ^/aas-env$ /aas-env/
    RedirectMatch 301 ^/aas-registry$ /aas-registry/
    RedirectMatch 301 ^/sm-registry$ /sm-registry/
    RedirectMatch 301 ^/aas-discovery$ /aas-discovery/
    RedirectMatch 301 ^/aas-ui$ /aas-ui/

    # -----------------------------
    # AAS Environment (compose: SERVER_SERVLET_CONTEXT_PATH=/aas-env)
    # -----------------------------
    ProxyPass        /aas-env/  http://aas-env:8081/aas-env/
    ProxyPassReverse /aas-env/  http://aas-env:8081/aas-env/

    # -----------------------------
    # AAS Registry (compose: /aas-registry)
    # -----------------------------
    ProxyPass        /aas-registry/  http://aas-registry:8080/aas-registry/
    ProxyPassReverse /aas-registry/  http://aas-registry:8080/aas-registry/

    # -----------------------------
    # Submodel Registry (compose: /sm-registry)
    # -----------------------------
    ProxyPass        /sm-registry/  http://sm-registry:8080/sm-registry/
    ProxyPassReverse /sm-registry/  http://sm-registry:8080/sm-registry/

    # -----------------------------
    # AAS Discovery Service (compose: SERVER_SERVLET_CONTEXT_PATH=/aas-discovery)
    # -----------------------------
    ProxyPass        /aas-discovery/  http://aas-discovery:8081/aas-discovery/
    ProxyPassReverse /aas-discovery/  http://aas-discovery:8081/aas-discovery/

    # -----------------------------
    # AAS Web UI (compose: BASE_PATH="/aas-ui")
    # NOTE: backend must serve under /aas-ui/
    # -----------------------------
    ProxyPass        /aas-ui/  http://aas-web-ui:3000/aas-ui/
    ProxyPassReverse /aas-ui/  http://aas-web-ui:3000/aas-ui/

    # Optional: header tweaks for iframe embedding (keep if you need embedding)
    Header unset X-Frame-Options
    Header unset Content-Security-Policy
    Header always set Content-Security-Policy "frame-ancestors 'self' https://demo3.digital-twin.host"
    Header always set X-Frame-Options "ALLOW-FROM https://demo3.digital-twin.host"

    # -----------------------------
    # Disabled routes (not present in your docker-compose.yml)
    # Uncomment only if you actually add these services.
    # -----------------------------
    # ProxyPass        /aas-registry-2/  http://aas-registry-2:8080/aas-registry-2/
    # ProxyPassReverse /aas-registry-2/  http://aas-registry-2:8080/aas-registry-2/
    #
    # ProxyPass        /sm-registry-2/   http://sm-registry-2:8080/sm-registry-2/
    # ProxyPassReverse /sm-registry-2/   http://sm-registry-2:8080/sm-registry-2/

    # -----------------------------
    # Root path reverse proxy (DISABLED)
    # Reason: sps-demonstrator-ui is NOT defined in your compose, so it causes DNS 500.
    # If you want a landing page, point "/" to an existing service.
    # -----------------------------
    # ProxyPass        /  http://sps-demonstrator-ui:3000/
    # ProxyPassReverse /  http://sps-demonstrator-ui:3000/

</VirtualHost>
